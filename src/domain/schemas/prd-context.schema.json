{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/prd-context.schema.json",
  "title": "PRD Context Schema",
  "type": "object",
  "additionalProperties": false,
  "required": ["schemaVersion", "meta", "problem", "goals", "scope", "requirements"],
  "properties": {
    "schemaVersion": { "type": "string", "const": "0.1" },
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title", "language", "updatedAt"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "title": { "type": "string", "minLength": 1 },
        "language": { "type": "string", "enum": ["zh", "en"] },
        "platform": {
          "type": "array",
          "items": { "type": "string", "enum": ["web", "ios", "android", "miniprogram", "desktop", "backend"] },
          "uniqueItems": true
        },
        "productType": {
          "type": "string",
          "enum": ["consumer", "business", "internal", "content", "ecommerce", "community", "tool", "other"]
        },
        "updatedAt": { "type": "string", "format": "date-time" },
        "source": { "type": "string", "enum": ["manual", "ai_assisted", "imported"] }
      }
    },
    "problem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["background", "problemStatement"],
      "properties": {
        "background": { "type": "string" },
        "problemStatement": { "type": "string", "minLength": 1 },
        "targetUsers": { "type": "array", "items": { "type": "string" } },
        "constraints": { "type": "array", "items": { "type": "string" } }
      }
    },
    "goals": {
      "type": "object",
      "additionalProperties": false,
      "required": ["goals", "nonGoals"],
      "properties": {
        "goals": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["goal", "metric"],
            "properties": {
              "goal": { "type": "string", "minLength": 1 },
              "metric": { "type": "string", "minLength": 1 },
              "baseline": { "type": "string" },
              "target": { "type": "string" },
              "timeWindow": { "type": "string" }
            }
          }
        },
        "nonGoals": { "type": "array", "items": { "type": "string" } }
      }
    },
    "scope": {
      "type": "object",
      "additionalProperties": false,
      "required": ["inScope", "outScope", "openQuestions"],
      "properties": {
        "inScope": { "type": "array", "items": { "type": "string" } },
        "outScope": { "type": "array", "items": { "type": "string" } },
        "assumptions": { "type": "array", "items": { "type": "string" } },
        "openQuestions": { "type": "array", "items": { "type": "string" } }
      }
    },
    "journeys": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "primary": { "type": "array", "items": { "$ref": "#/$defs/journeyStep" } },
        "secondary": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name", "steps"],
            "properties": {
              "name": { "type": "string" },
              "steps": { "type": "array", "items": { "$ref": "#/$defs/journeyStep" } }
            }
          }
        }
      }
    },
    "requirements": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/$defs/requirement" }
    },
    "tracking": {
      "type": "object",
      "additionalProperties": false,
      "properties": { "events": { "type": "array", "items": { "$ref": "#/$defs/trackingEvent" } } }
    },
    "nfr": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "items": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type", "requirement"],
            "properties": {
              "type": { "type": "string", "enum": ["performance", "availability", "security", "privacy", "accessibility", "other"] },
              "requirement": { "type": "string", "minLength": 1 }
            }
          }
        }
      }
    },
    "release": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "plan": { "type": "array", "items": { "type": "string" } },
        "monitoring": { "type": "array", "items": { "type": "string" } },
        "rollback": { "type": "array", "items": { "type": "string" } }
      }
    },
    "glossary": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "terms": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["term", "definition"],
            "properties": {
              "term": { "type": "string", "minLength": 1 },
              "definition": { "type": "string", "minLength": 1 }
            }
          }
        }
      }
    },
    "changeLog": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "summary": { "type": "string" },
        "changes": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type", "detail"],
            "properties": {
              "type": { "type": "string", "enum": ["added", "modified", "removed", "fixed"] },
              "detail": { "type": "string", "minLength": 1 }
            }
          }
        }
      }
    }
  },
  "$defs": {
    "journeyStep": {
      "type": "object",
      "additionalProperties": false,
      "required": ["stepTitle", "userIntent", "systemResponse"],
      "properties": {
        "stepTitle": { "type": "string", "minLength": 1 },
        "userIntent": { "type": "string", "minLength": 1 },
        "systemResponse": { "type": "string", "minLength": 1 }
      }
    },
    "givenWhenThen": {
      "type": "object",
      "additionalProperties": false,
      "required": ["given", "when", "then"],
      "properties": {
        "given": { "type": "string", "minLength": 1 },
        "when": { "type": "string", "minLength": 1 },
        "then": { "type": "string", "minLength": 1 }
      }
    },
    "requirementFlowStep": {
      "type": "object",
      "additionalProperties": false,
      "required": ["step", "action", "system"],
      "properties": {
        "step": { "type": "integer", "minimum": 1 },
        "action": { "type": "string", "minLength": 1 },
        "system": { "type": "string", "minLength": 1 }
      }
    },
    "requirement": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title", "priority", "userStory", "acceptance", "edgeCases"],
      "properties": {
        "id": { "type": "string", "pattern": "^[A-Za-z][A-Za-z0-9_-]{1,63}$" },
        "title": { "type": "string", "minLength": 1 },
        "priority": { "type": "string", "enum": ["P0", "P1", "P2"] },
        "userStory": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "flows": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "main": { "type": "array", "items": { "$ref": "#/$defs/requirementFlowStep" } },
            "alternatives": { "type": "array", "items": { "$ref": "#/$defs/requirementFlowStep" } }
          }
        },
        "acceptance": { "type": "array", "minItems": 1, "items": { "$ref": "#/$defs/givenWhenThen" } },
        "edgeCases": { "type": "array", "minItems": 1, "items": { "type": "string" } },
        "dependencies": { "type": "array", "items": { "type": "string" } },
        "trackingRefs": { "type": "array", "items": { "type": "string" } },
        "codingNotes": { "type": "array", "items": { "type": "string" } }
      }
    },
    "trackingEvent": {
      "type": "object",
      "additionalProperties": false,
      "required": ["eventName", "trigger"],
      "properties": {
        "eventName": { "type": "string", "minLength": 1 },
        "trigger": { "type": "string", "minLength": 1 },
        "properties": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["name", "type"],
            "properties": {
              "name": { "type": "string", "minLength": 1 },
              "type": { "type": "string", "enum": ["string", "number", "boolean", "enum", "object"] },
              "description": { "type": "string" }
            }
          }
        },
        "metricMapping": { "type": "string" }
      }
    }
  }
}
